---

copyright:
  years: 2016, 2018
lastupdated: "2018-3-22"
---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:screen:.screen}
{:codeblock:.codeblock}


# Delivery Pipeline の概要
{: #deliverypipeline_about}

{{site.data.keyword.contdelivery_full}} には、最小限の人的介入でビルド、テスト、デプロイを反復可能な形で行うための Delivery Pipeline が組み込まれています。 パイプラインでは、一連のステージにより入力内容を取得して、
ビルド、テスト、およびデプロイメントなどのジョブを実行します。
{:shortdesc}

以降のセクションでは、パイプラインの背景にある概念的な詳細を説明します。

## ステージ
{: #deliverypipeline_stages}

ステージは、コードのビルド、デプロイ、およびテスト時に、入力内容とジョブを編成します。 ステージは、ソース制御リポジトリー (SCM リポジトリー) からの入力か、他のステージのビルド・ジョブ (ビルド成果物) からの入力を受け入れます。 最初のステージを作成するときに、**「入力」**タブにデフォルト設定がセットされます。

ステージの入力内容は、そのステージに含まれるジョブに渡され、各ジョブには、ジョブの実行場所となるクリーンなコンテナーが与えられます。

**重要**: ステージ内のジョブ間で相互に成果物を渡すことはできません。 ステージ間で成果物を受け渡すことができないため、デプロイ・ステージでビルド・ステージの成果物を使用する場合は、デプロイ・ステージから別個のビルド・ステージを用意する必要があります。

すべてのジョブで使用可能なステージ環境プロパティーを定義することができます。 例えば、単一のステージでジョブをデプロイしてテストするために単一の URL を渡す `TEST_URL` プロパティーを定義することができます。デプロイ・ジョブは、その URL にデプロイし、テスト・ジョブは、URL で実行中のアプリをテストします。

デフォルトでは、ステージでは、変更がプロジェクトの SCM リポジトリーに送信されるたびに、ビルドとデプロイメントが自動的に実行されます。ステージとジョブは順次実行され、作業のフロー制御を可能にします。 例えば、デプロイメント・ステージの前にテスト・ステージを配置すること
ができます。 テスト・ステージでテストが失敗すると、デプロイメント・ステージは実行されません。

特定のステージの制御を厳しくすることができます。 入力時に変更が発生するたびにステージが実行されないようにするには、機能を無効にすることができます。 **「入力」**タブの「ステージ・トリガー」セクションで、**「このステージが手動で実行されたときにのみジョブを実行」**をクリックします。

![「入力」タブ](images/input_tab_only_execute.png)


### ビルド・ステージ
{: #build_stage}

<!-- Need the Pipeline team to fill out what each builder does and possible add an example -->
ビルド・ステージは、成果物のビルド方法を示す**ビルダー・タイプ** を指定します。  以下のビルダー・タイプを使用できます。

1. **シンプル** - **シンプル**・ビルダー・タイプを使用する場合は、コードのコンパイルまたはビルドは行われません。パッケージ化され、今後のステージで使用できる状態になります。
2. **Ant**
3. **Container Registry**
4. **Gradle**
5. **Gradle (Artifactory、Nexus、または SonarQube)**
6. **Grunt**
7. **IBM Globalization Pipeline**
8. **Maven**
9. **Maven (Artifactory、Nexus、または SonarQube)**
10. **npm**
11. **npm (Artifactory または Nexus)**
12. **シェル・スクリプト**

### デプロイ・ステージ
デプロイ・ステージでは、ビルド・ステージからの入力を指定します。デプロイ・ステージのジョブでは、**デプロイヤー・タイプ**を指定します。以下のデプロイヤー・タイプを使用できます。

1. **Cloud Foundry**
2. **Kubernetes**

## ジョブ
{: #deliverypipeline_jobs}

ジョブは、ステージ内の実行単位です。 ステージには複数のジョブを含めることができ、ステージ内のジョブは順次実行されます。 デフォルトでは、ジョブが失敗すると、ステージ内の以降のジョブは実行されません。

![ステージ内のジョブのビルドとテスト](images/jobs.png)

ジョブは、各パイプラインの実行用に作成された Docker コンテナー内にある、個別の作業ディレクトリーで実行されます。 ジョブが実行される前に、ステージ・レベルで定義された入力データがその作業ディレクトリーに取り込まれます。 例えば、テスト・ジョブとデプロイ・ジョブを含むステージがあるとします。 1 つのジョブで依存関係をインストールすると、その依存関係はもう一方のジョブ
では使用できません。 ただし、ステージの入力で依存関係を使用可能にすると、どちらのジョブでも使用可能となります。

単純タイプのビルド・ジョブを除き、ジョブを構成する際は、ビルド・コマンド、テスト・コマンド、またはデプロイメントの各コマンドを含む UNIX シェル・スクリプトを含めることができます。 ジョブは暫定のコンテナーで実行されるため、複数のジョブが同じステージ
の一部である場合でも、1 つのジョブのアクションが他のジョブの実行環境に影響を与えることはできません。

サンプルの bod およびデプロイ・スクリプトは、[https://github.com/open-toolchain/commons](https://github.com/open-toolchain/commons) にあります。

さらに、パイプライン・ジョブは、`sudo` として次のコマンドのみを実行できます。
  * `/usr/sbin/service`
  * `/usr/bin/apt-get`
  * `/usr/bin/apt-key`
  * `/usr/bin/dpkg`
  * `/usr/bin/add-apt-repository`
  * `/opt/IBM/node-v0.10.40-linux-x64/npm`
  * `/opt/IBM/node-v0.12.7-linux-x64/npm`
  * `/opt/IBM/node-v4.2.2-linux-x64/npm`
  * `/usr/bin/Xvfb`
  * `/usr/bin/pip`


ジョブの実行後、そのジョブ用に作成されたコンテナーは破棄されます。 ジョブの実行結果は永続できますが、実行環境は永続しません。

**注:** ジョブは最大で 60 分実行することができます。 その限界を超えると、ジョブは失敗します。 ジョブが限界を超える場合は、複数の
ジョブに分割してください。 例えば、1 つのジョブが 3 つのタスクを実行する場合、1 つのタスクが 1 つのジョブとなるように、そのジョブを 3 つのジョブに分割することができます。

ジョブをステージに追加する方法については、[ジョブのステージへの追加](/docs/services/ContinuousDelivery/pipeline_build_deploy.html#deliverypipeline_add_job){: new_window}を参照してください。

### ビルド・ジョブ

ビルド・ジョブは、デプロイメントに備えてプロジェクトをコンパイルします。 ビルド・ジョブは、ビルド・アーカイブ・ディレクトリーに送信することができる成果物を生成しますが、デフォルトで成果物はプロジェクトのルート・ディレクトリーに配置されます。

ビルド・ジョブからの入力データを取得するジョブは、ジョブが作成されたのと同じ構造のビルド成果物を参照する必要があります。 例えば、ビルド・ジョブがビルド成果物を `output` ディレクトリーにアーカイブする場合、デプロイ・スクリプトは、プロジェクトのルート・ディレク
トリーではなく `output` ディレクトリーを参照して、コンパイルされたプロジェクトをデプロイします。 **「ビルド・アーカイブ・ディレクトリー」**フィールドにディレクトリー名を入力することにより、アーカイブするディレクトリーを指定できます。 このフィールドをブランクにしておくと、ルート・ディレクトリーにアーカイブされます。

**注:** **シンプル**・ビルダー・タイプを使用する場合は、コードのコンパイルはビルドは行われません。パッケージ化され、今後のステージで使用できる状態になります。

Cloud Foundry を使用してデプロイするとき、アプリを実行できるようにするための適切な成果物が Cloud Foundry に含まれています。 詳しくは、[cf コマンドを使用してのアプリケーションのデプロイ](https://console.ng.bluemix.net/docs/manageapps/depapps.html#dep_apps)を参照してください。 Cloud Foundry アプリ用パイプラインには、cf コマンドを実行するデプロイ・ステージが含まれています。

Cloud Foundry は、[使用するビルドパックを検出 ![外部リンク・アイコン](../../icons/launch-glyph.svg "外部リンク・アイコン")](http://docs.cloudfoundry.org/buildpacks/detection.html) しようとします。 使用する[ビルドパック](/docs/cfapps/byob.html#using-community-buildpacks)は、アプリのルート・フォルダー内のマニフェスト・ファイルで指定できます。 ビルドパックは通常、ユーザー提供の成果物を調べることにより、どの依存関係をダウンロードするか、バインド済みサービスと通信するためにアプリケーションをどのように構成するかを判別します。 マニフェスト・ファイルについて詳しくは、[アプリケーション・マニフェスト](/docs/manageapps/depapps.html#appmanifest)を参照してください。

### デプロイ・ジョブ

デプロイ・ジョブは、プロジェクトをアプリとして {{site.data.keyword.Bluemix_notm}} にアップロードし、URL からアクセス可能です。 プロジェクトのデプロイ後は、デプロイされたアプリを {{site.data.keyword.Bluemix_notm}} ダッシュボードで検索することができます。

デプロイ・ジョブは、新規アプリをデプロイすることも、既存アプリを更新することもできます。 Cloud Foundry コマンド・ライン・インターフェースや Web IDE の実行バーなどの別の方法で最初にアプリをデプロイしていても、デプロイ・ジョブを使用してアプリを更新することができます。 デプロイ・ジョブでアプリを更新するには、アプリの名前を使用します。

1 つ以上の地域やサービスにデプロイできます。 例えば、1 つ以上のサービスを使用して、1 つの地域でテストし、複数の地域で実動にデプロイするよう {{site.data.keyword.deliverypipeline}} をセットアップできます。 詳しくは、[地域](/docs/overview/whatisbluemix.html#ov_intro_reg){: new_window}を参照してください。

### テスト・ジョブ
条件を満たすことが必要な場合は、ビルド・ジョブおよびデプロイ・ジョブの前または後にテスト・ジョブを組み込みます。 必要に応じて、テスト・ジョブを単純タイプまた
は複雑タイプにカスタマイズすることができます。 例えば、cURL コマンドを実行して特定の応答を予期することができます。 また、一連の単体テストを実行したり、Sauce Labs などサード・パーティーのテスト・サービスを使用して機能テストを実行したりすることもできます。

テストの結果ファイルが JUnit XML 形式の場合、結果ファイルに基づいたレポートが各テスト結果ページの**「テスト」**タブに表示されます。 テストが不合格の場合は、ジョブも失敗します。

## 環境プロパティー (環境変数)
{: #environment_properties}

ジョブのシェル・コマンド内に環境プロパティーを含めることができます。 このプロパティーは、ジョブの実行環境に関する情報へのアクセスを
提供します。 詳しくは、[{{site.data.keyword.deliverypipeline}} サービスの環境プロパティーとリソース](/docs/services/ContinuousDelivery/pipeline_deploy_var.html)を参照してください。  プロパティーをエクスポートすることによって、同じステージ内のジョブ間で環境プロパティーを受け渡すことができます。  ステージ間で環境プロパティーを受け渡すには、ステージのリポジトリーに `build.properties` ファイルを作成し、次のステージで `>build.properties` を実行します。  例えば、ビルド・ジョブで以下のコマンドをビルド・スクリプトに組み込むことができます。

    `echo "IMAGE_NAME=${FULL_REPOSITORY_NAME}" >> $ARCHIVE_DIR/build.properties`

    `build.properties` ファイルがある場合は、それを実行することですべてのジョブが開始されます。

## 成果物の作成および使用
{: #artifacts}

ビルド・ジョブは、ユーザー・スクリプトが実行されている現在のフォルダー内のコンテンツを自動的に取り出します。  後のデプロイメントで git リポジトリー全体を必要としない場合は、明示的な出力ディレクトリーを構成し、そこに関連成果物をコピーまたは作成することをお勧めします。ジョブ・スクリプトはビルド結果 (出力ディレクトリー) で実行されます。

Cloud Foundry にデプロイするデプロイ・ジョブでは、成果物をデプロイする組織とスペースを指定する必要があります。アプリを実行するために追加のサービスが必要な場合は、それらを `manifest.yml` ファイルで指定する必要があります。

IBM Cloud Container Service を Kubernetes クラスターにデプロイするデプロイ・ジョブには、Dockerfile とオプションの Helm チャートが必要です。  

ジョブ・スクリプトは、ジョブがターゲット環境にログインした後に実行されます (したがって、スクリプトで `cf push` コマンドまたは `kubectl` コマンドを実行できます)。

## サンプル・パイプライン
{: #deliverypipeline_example}

サンプル・パイプラインには次の 3 つのステージを含めることができます。

1. アプリのビルド・プロセスをコンパイルして実行するビルド・ステージ。
2. アプリのインスタンスをデプロイして、それに対してテストを実行するテスト・ステージ。
3. テスト済みのアプリの実動インスタンスをデプロイする実動ステージ。

次の概念図に、このパイプラインを示しています。

![パイプライン内のステージとジョブの概念図](images/diagram.jpg)

*3 ステージのパイプラインの概念モデル*

各ステージは、その入力データをリポジトリーとビルド・ジョブから取り出し、ステージ内のジョブは、互いに独立して順次実行されます。 サンプル・パイプラインでは、テスト・ステージと実動ステージの両方がビルド・ステージの出力を入力データとして使用する場合でも、ステージは順次実行されます。

## Cloud Foundry マニフェスト・ファイル
{: #deliverypipeline_manifest}

マニフェスト・ファイルは、`manifest.yml` という名前でプロジェクトのルート・ディレクトリーに格納されます。このファイルは、プロジェクトの {{site.data.keyword.Bluemix_notm}} へのデプロイ方法を制御します。 プロジェクト用のマニフェスト・ファイルの作成について詳しくは、[アプリケーション・マニフェストに関する {{site.data.keyword.Bluemix_notm}} の資料](/docs/manageapps/depapps.html#appmanifest)を参照してください。 プロジェクトを {{site.data.keyword.Bluemix_notm}} と統合するには、そのプロジェクトのルート・ディレクトリーにマニフェスト・ファイルが必要です。 ただし、そのファイルの情報に基づいてデプロイする必要はありません。

パイプラインでは、`cf push` コマンド引数を使用して、マニフェスト・ファイルで指定可能なすべての設定を指定できます。`cf push` コマンド引数は、複数のデプロイメント・ターゲットがあるプロジェクトで有用です。 複数のデプロイ・ジョブがすべてプロジェクト・マニフェスト・ファイルで指定されるルートを使用しようとすると、競合が発生します。

競合を避けるには、`cf push`、続けてホスト名引数、`-n`、およびルート名を使用して、ルートを指定することができます。 個々のステージでデプロイメント・スクリプトを変更することにより、複数のターゲットにデプロイする際のルートの競合を回避できます。

`cf push` コマンド引数を使用するには、デプロイ・ジョブの構成設定を開き、**「デプロイ・スクリプト」**フィールドを変更します。 詳しくは、[Cloud Foundry Push 資料![外部リンク・アイコン](../../icons/launch-glyph.svg "外部リンク・アイコン")](http://docs.cloudfoundry.org/devguide/installcf/whats-new-v6.html#push){: new_window} を参照してください。
